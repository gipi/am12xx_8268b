#include <stdlib.h>
#include <stdio.h>
#include <errno.h>
#include <sys/types.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <linux/string.h>
#include "sys_buf.h"
#include "display.h"
#include "sys_cfg.h"

void Mouse_Move(int init, int x, int y, int lcd_width, int lcd_height);


#define TEXT_RENDER_OFFSETX 1
#define TEXT_RENDER_OFFSETY 1
#define CURSOR_OFFSETY 1
#define SATURATION(x,cond,value) ((x)=((x)cond(value))?(value):(x))
#define MIN(a,b) (((a) < (b)) ? (a) : (b))
#define MAX(a,b) (((a) > (b)) ? (a) : (b))

extern int imagew,imageh;


#define ICON_TOP 2
#define ICON_SIZE 32
#define ICON_STRIDE 64

static INT32U pallet_beam[8]=
{
	0xffff,//P1P0
	0x0,//P3P2
	0x0,//P5P4
	0x0,//P7P6
	0x0,//P9P8
	0x0,//PbPa
	0x0,//PdPc
	0x0,//PfPe
};
static INT32U osd_cur_beam[] =
{
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x11110000,0x00011110,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00010000,0x00010001,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x11110000,0x00011110,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x10000000,0x00000010,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x11110000,0x00011110,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00010000,0x00010001,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x11110000,0x00011110,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0xffffffff,
};


static INT32U pallet_hand[8]=
{
	0xffff,//P1P0
	0x8430c618,//P3P2
	0xbdf7c618,//P5P4
	0x84108410,//P7P6
	0x4a6952aa,//P9P8
	0x42284228,//PbPa
	0x39c74228,//PdPc
	0x18e318e3,//PfPe
};
static INT32U osd_cur_hand[] =
{
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000063,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x00000125,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x00000122,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x00000122,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x00000124,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x00067142,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x67122122,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x22154122,0x00000001,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x22122122,0x00000661,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30001630,0x22122122,0x00001251,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30012230,0x22622722,0x00001221,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x70122300,0x22225242,0x00001257,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x11222300,0x25522222,0x00001422,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x22223000,0x22222224,0x00001222,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x22223000,0x22222222,0x00001222,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x22230000,0x22222222,0x00001222,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x22230000,0x22222222,0x00000125,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x22300000,0x22442242,0x00000122,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x25300000,0x22242422,0x00000122,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x23000000,0x52255222,0x00000012,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x30000000,0x25222224,0x00000012,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x52222223,0x00000001,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x52222223,0x00000001,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0xffffffff,
};


/*
static INT32U pallet_arrow[8]=	//black
{
0xe73cffff,//P1P0
0xce79e73c,//P3P2
0xb5b6ce79,//P5P4
0x7bcfa514,//P7P6
0x632c632c,//P9P8
0x528a52aa,//PbPa
0x31a64228,//PdPc
0x31a6,//PfPe
};//PfPe
*/
static INT32U pallet_arrow[8]=	//white
{
0x18c3ffff,//P1P0
0x328628c3,//P3P2
0x4a493286,//P5P4
0x84305aeb,//P7P6
0x9cd39cd3,//P9P8
0xad75ad55,//PbPa
0xde59bdd7,//PdPc
0xce59,//PfPe
};//PfPe
static INT32U osd_cur_arrow[] = 
{
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x0000000e,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x000000de,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000eee,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x0000deee,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x000edeee,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00eedeee,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x0dedeede,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0xeeededed,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x000eedee,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x000de0ed,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00ed000e,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00ee0000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x0ee00000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x0ee00000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,0x00000000,
	0xffffffff,
};

static unsigned short cursor_rgb565_bk[ICON_SIZE*ICON_SIZE]; 


typedef struct 
{
	INT32U* pPallet;		/**<调色板数据*/
	INT32U  iTransColor;	/**<透明色(RGB565格式)*/
	unsigned char  iTransColorIndex;	/**<透明色索引值*/
}Osd_Pallet;

typedef enum 
{
	INITIALIZED=0x1,
	SHOW=0x2,
}MOUSESTATE;

static int GlobalMouseX=0;
static int GlobalMouseY=0;
static int MouseState=SHOW;

static struct mem_dev mem;
static unsigned  short*cursor_rgb565;
static unsigned int *cursor_4bit;

static void OSD_CONFIG(int OsdConfig,
				int enable,
				unsigned long addr,
				int x,
				int y,
				int w,
				int h)
{
	void* ds_inst;
	static DE_config ds_conf;

	de_init(&ds_inst);
	de_get_config(ds_inst,&ds_conf,OsdConfig);

	if(enable==1)
	{
		ds_conf.osd_input2.enable = enable;
		ds_conf.osd_input2.stride = ICON_STRIDE;
		ds_conf.osd_input2.pix_fmt= DE_PIX_FMT_OSDBIT16MODE;
		ds_conf.osd_input2.img = (unsigned long *)cursor_rgb565;
		ds_conf.osd_input2.bus_addr = addr;
		ds_conf.osd_input2.tparent_color = 0xf8fcf8;
		ds_conf.osd_input2.idx_fmt = 0;

		ds_conf.osd_output2.alpha = 8;
		ds_conf.osd_output2.pip_x = x;
		ds_conf.osd_output2.pip_y = y;
		ds_conf.osd_output2.width = w;
		ds_conf.osd_output2.height = h;
	}
	else
	{
		ds_conf.osd_input2.enable = 0;
	}

	de_set_Config(ds_inst,&ds_conf,OsdConfig);
	de_release(ds_inst);
}


int GetMouseX()
{
	return GlobalMouseX;
}

int GetMouseY()
{
	return GlobalMouseY;
}

int IsMouseInit()
{
	return ((MouseState & INITIALIZED)!=0);
}


int IsMouseVisible()
{
	return ((MouseState & INITIALIZED) && (MouseState&SHOW));
}

static void bit4_2_rgb565(unsigned int *bit4, int len, unsigned int *pallet, unsigned short *rgb565)
{
	int i;
	unsigned int pallet_index;
	int bit4_index, bit4_off;
	static unsigned int bit4_mask[8] = 
	{
		0xf, 0xf0, 0xf00, 0xf000, 0xf0000, 0xf00000, 0xf000000, 0xf0000000
	};
	for(i=0; i<len; i++)
	{
		bit4_index = i/8;
		bit4_off = i%8;
		pallet_index = ( bit4[bit4_index] & bit4_mask[bit4_off] )>>(bit4_off*4);
		if(pallet_index%2)
			rgb565[i] = (pallet[pallet_index/2]>>16) & 0xffff;
		else
			rgb565[i] = pallet[pallet_index/2] & 0xffff;
	}
}


int Mouse_init(int x, int y)
{
	int fd;
	int ret;
	int i;

	GlobalMouseX = x;
	GlobalMouseY = y;

	printf("in Mouse_init---x=%d,y=%d\n",x,y);

	if(MouseState & INITIALIZED)
	{
		Mouse_Move(0, x, y, imagew, imageh);
		printf("Mouse already init\n");
		return 0;
	}

	mem.request_size = ICON_STRIDE*ICON_SIZE*2;
	mem.buf_attr = UNCACHE;

	printf("~~~~~~~~~~~~mouse buffer size:%d\n",mem.request_size);
	fd = open("/dev/sysbuf",O_RDWR);
	ret=ioctl(fd,MEM_GET,&mem);
	if(ret<0)
	{
		printf("~~~~~~~~~~~~~memory failed");
		return -1;
	}
	cursor_rgb565=(unsigned short *)mem.logic_address;
	for(i=0; i<ICON_STRIDE*ICON_SIZE; i++)
	{
		cursor_rgb565[i] = 0xffff;
	}

	MouseState |= INITIALIZED;
	Mouse_Move(0, x, y, imagew, imageh);

	return 0;
}


void Mouse_Position_Change(int init, int x, int y, int lcd_width, int lcd_height)
{

	x = MAX(x, 0);
	y = MAX(y, 0);
	x = MIN(x, lcd_width-1);
	y = MIN(y, lcd_height-1);
	
	GlobalMouseX = x;
	GlobalMouseY = y;
}


void Mouse_Move(int init, int x, int y, int lcd_width, int lcd_height)
{
	static Osd_Pallet osd_pallet;
	
	static int initialize = 0;
	int dst_x ;
	int dst_y;
	
	int w;
	int h;

	int data_offset_x=0;
	int data_offset_y=0;

	int i;

	x = MAX(x, 0);
	y = MAX(y, 0);
	x = MIN(x, lcd_width-1);
	y = MIN(y, lcd_height-1);
	
	GlobalMouseX = x;
	GlobalMouseY = y;

	if(!IsMouseVisible())
	{
		return;
	}

	printf("mouse move : %d,%d,%d,%d\n",x,y,lcd_width,lcd_height);

	if(x<=(lcd_width-ICON_SIZE))
	{
		data_offset_x = ICON_SIZE;
		dst_x = x;
		w = ICON_SIZE;
	}
	else
	{
		data_offset_x = 0;
		dst_x = (lcd_width-ICON_SIZE);
		w = ICON_SIZE;
	}

	if(y <= (lcd_height-(ICON_SIZE-ICON_TOP)))
	{
		data_offset_y = ICON_TOP;
		dst_y = y;
		h = (ICON_SIZE - ICON_TOP);
	}
	else
	{
		data_offset_y = 0;
		dst_y = y - ICON_TOP;
		h = (lcd_height-dst_y);
	}

	if(initialize == 0 || (init != 0 && init != initialize))
	{
		initialize = (init == 0) ? 1 : init;
		if(1==initialize)
		{
			osd_pallet.pPallet = pallet_arrow;
			osd_pallet.iTransColor = pallet_arrow[0]&0xffff;
			osd_pallet.iTransColorIndex = 0x0;

			cursor_4bit = osd_cur_arrow;
		}
		else if(2==initialize)
		{
			osd_pallet.pPallet = pallet_hand;
			osd_pallet.iTransColor = pallet_hand[0]&0xffff;
			osd_pallet.iTransColorIndex = 0x0;

			cursor_4bit = osd_cur_hand;
		}
		else if(3==initialize)
		{
			osd_pallet.pPallet = pallet_beam;
			osd_pallet.iTransColor = pallet_beam[0]&0xffff;
			osd_pallet.iTransColorIndex = 0x0;

			cursor_4bit = osd_cur_beam;
		}

		bit4_2_rgb565(cursor_4bit, ICON_STRIDE*ICON_SIZE, osd_pallet.pPallet, cursor_rgb565);
		for(i=0; i<ICON_SIZE; i++)
		{
			memcpy(cursor_rgb565_bk+i*ICON_SIZE,
					cursor_rgb565+i*ICON_STRIDE+ICON_SIZE,
					ICON_SIZE*2);
		}

		if(data_offset_x == 0)
		{
			for(i=0; i<ICON_SIZE; i++)
			{
				memset(cursor_rgb565+i*ICON_STRIDE, 0xff, ICON_SIZE*2);
				memcpy(cursor_rgb565+i*ICON_STRIDE+x+ICON_SIZE-lcd_width,
						cursor_rgb565_bk+i*ICON_SIZE,
						(lcd_width-x)*2);
			}
		}
		
		OSD_CONFIG(DE_CFG_OSD2,
				1,
				(mem.physic_address+((ICON_STRIDE*data_offset_y+data_offset_x)*2)),
				dst_x + 1,
				dst_y + 1,
				w,
				h);
		
	}
	else
	{
		if(data_offset_x == 0)
		{
			for(i=0; i<ICON_SIZE; i++)
			{
				memset(cursor_rgb565+i*ICON_STRIDE, 0xff, ICON_SIZE*2);
				memcpy(cursor_rgb565+i*ICON_STRIDE+x+ICON_SIZE-lcd_width,
						cursor_rgb565_bk+i*ICON_SIZE,
						(lcd_width-x)*2);
			}
		}

		OSD_CONFIG(DE_CFG_OSD2,
				1,
				(mem.physic_address+((ICON_STRIDE*data_offset_y+data_offset_x)*2)),
				dst_x + 1,
				dst_y + 1,
				w,
				h);
	}
}


